services:
  # --- 1. THE SOURCE (OLTP) ---
  postgres_app:
    image: postgres:15
    hostname: postgres_app
    ports: [ "5432:5432" ]
    environment:
      POSTGRES_USER: app_user
      POSTGRES_PASSWORD: app_password
      POSTGRES_DB: app_db

  # --- 2. THE CATALOG (Nessie + its DB) ---
  nessie:
    image: ghcr.io/projectnessie/nessie:latest
    ports: [ "19120:19120" ]
    environment:
      QUARKUS_DATASOURCE_DB_KIND: postgresql
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres_catalog:5432/nessie_catalog
      QUARKUS_DATASOURCE_USERNAME: catalog_user
      QUARKUS_DATASOURCE_PASSWORD: catalog_password
      NESSIE_CATALOG_DEFAULT_WAREHOUSE: warehouse
      NESSIE_CATALOG_WAREHOUSES_WAREHOUSE_LOCATION: s3://lake-data
      NESSIE_CATALOG_WAREHOUSES_WAREHOUSE_S3_ENDPOINT: http://minio:9000
      NESSIE_CATALOG_WAREHOUSES_WAREHOUSE_S3_ACCESS__KEY__ID: admin
      NESSIE_CATALOG_WAREHOUSES_WAREHOUSE_S3_SECRET__ACCESS__KEY: password
      NESSIE_CATALOG_WAREHOUSES_WAREHOUSE_S3_PATH__STYLE__ACCESS: "true"
      NESSIE_CATALOG_WAREHOUSES_WAREHOUSE_S3_REGION: us-east-1
    depends_on: [ postgres_catalog, minio ]

  postgres_catalog:
    image: postgres:15
    environment:
      POSTGRES_USER: catalog_user
      POSTGRES_PASSWORD: catalog_password
      POSTGRES_DB: nessie_catalog

  # --- 3. THE STORAGE (MinIO) ---
  minio:
    image: minio/minio
    ports: [ "9000:9000", "9001:9001" ]
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
    command: server /data --console-address ":9001"

  # --- 3b. THE GATEWAY (Sidecar) ---
  warehouse-sidecar:
    image: python:3.9-slim
    command: tail -f /dev/null
    volumes:
      - .:/app
    depends_on: [ minio ]

  # --- 4. ENGINE A: BATCH (Trino) ---
  trino:
    image: trinodb/trino:latest
    hostname: trino
    ports: [ "8080:8080" ]

    volumes:
      - ./trino/catalog:/etc/trino/catalog
    depends_on: [ nessie, minio ]

  # --- 5. ENGINE B: SPEED (ClickHouse) ---
  clickhouse:
    image: clickhouse/clickhouse-server
    ports: [ "8123:8123", "9009:9009" ]
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ulimits:
      nofile: { soft: 262144, hard: 262144 }
    depends_on: [ minio ]

  # --- 6. THE ROUTER (Brain + DuckDB) ---
  router:
    build: .
    ports: [ "8000:8000" ]
    environment:
      - POSTGRES_HOST=postgres_app
      - CLICKHOUSE_HOST=clickhouse
      - TRINO_HOST=trino
      - NESSIE_URL=http://nessie:19120/api/v1
      - S3_ENDPOINT=http://minio:9000
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    depends_on: [ postgres_app, trino, clickhouse ]

  # --- 7. STREAMING INGESTION (Kafka + Zookeeper) ---
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    hostname: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    hostname: kafka
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    depends_on:
      - zookeeper

  # --- 8. STREAM PROCESSING (Flink) ---
  flink-jobmanager:
    image: flink:1.18-java11
    hostname: flink-jobmanager
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - FLINK_PROPERTIES=jobmanager.rpc.address: flink-jobmanager

  flink-taskmanager:
    image: flink:1.18-java11
    depends_on:
      - flink-jobmanager
    command: taskmanager
    environment:
      - FLINK_PROPERTIES=jobmanager.rpc.address: flink-jobmanager
                         taskmanager.numberOfTaskSlots: 2
